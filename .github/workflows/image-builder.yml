name: 'Image Builder and VMSS Provisioning'

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Name of the gallery image to use'
        required: true
        default: 'java-tomcat-image'
        type: string
      os_type:
        description: 'OS type: linux or windows'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - windows
      kv_name:
        description: 'Azure Key Vault name'
        required: true
        default: 'rgdevazurevmimagesmgmtkv'
        type: string    

env:
  RESOURCE_GROUP: 'rg-dev-azure-vm-images-mgmt'
  GALLERY_NAME: 'rgdevazurevmimagesmgmtga'
  LOCATION: 'westeurope'

jobs:
  provision-vmss:
    runs-on: windows-latest  # Use Windows runner for PowerShell

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get Public IP
      run: |
        $publicIp = (Invoke-WebRequest -Uri "https://api.ipify.org").Content
        echo "PUBLIC_IP=$publicIp" >> $env:GITHUB_ENV

    - name: Update Key Vault Network ACLs
      run: |
        $KV_NAME = "${{ inputs.kv_name }}"
        if ($KV_NAME -eq "") {
          $KV_NAME = "rgdevazurevmimagesmgmtkv"
        }
        $kvExists = az keyvault show --name $KV_NAME --query name -o tsv 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Key Vault $KV_NAME exists. Adding IP $env:PUBLIC_IP to allowed IPs."
          az keyvault network-rule add --name $KV_NAME --ip-address "$env:PUBLIC_IP/32"
        } else {
          Write-Host "Key Vault $KV_NAME does not exist. Skipping IP whitelisting."
        }
      shell: pwsh

    - name: Create Image Version
      run: |
        $endOfLife = (Get-Date).AddMonths(1)
        $sourceImageId = "/subscriptions/$env:ARM_SUBSCRIPTION_ID/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Compute/images/${{ inputs.image_name }}-managed"
        New-AzGalleryImageVersion `
          -ResourceGroupName ${{ env.RESOURCE_GROUP }} `
          -GalleryName ${{ env.GALLERY_NAME }} `
          -GalleryImageDefinitionName ${{ inputs.image_name }} `
          -Name "latest" `
          -Location ${{ env.LOCATION }} `
          -SourceImageId $sourceImageId `
          -EndOfLife $endOfLife `
          -TargetRegion @{Name="${{ env.LOCATION }}";RegionalReplicaCount=1}

    - name: Get Image ID
      run: |
        $imageId = az sig image-version show `
          --resource-group ${{ env.RESOURCE_GROUP }} `
          --gallery-name ${{ env.GALLERY_NAME }} `
          --gallery-image-definition ${{ inputs.image_name }} `
          --gallery-image-version "latest" `
          --query "id" -o tsv
        echo "IMAGE_ID=$imageId" >> $env:GITHUB_ENV

    - name: Provision VMSS
      run: |
        if ('${{ inputs.os_type }}' -eq 'linux') {
          az vmss create `
            --resource-group ${{ env.RESOURCE_GROUP }} `
            --name "${{ env.RESOURCE_GROUP }}-vmss" `
            --image $env:IMAGE_ID `
            --admin-username "adminuser" `
            --generate-ssh-keys `
            --instance-count 1 `
            --vm-sku "Standard_B1s" `
            --location ${{ env.LOCATION }}
        } else {
          $password = az keyvault secret show `
            --vault-name "rgdevazurevmimagesmgmtkv" `
            --name "admin-password" `
            --query "value" -o tsv
          az vmss create `
            --resource-group ${{ env.RESOURCE_GROUP }} `
            --name "${{ env.RESOURCE_GROUP }}-vmss" `
            --image $env:IMAGE_ID `
            --admin-username "adminuser" `
            --admin-password $password `
            --instance-count 1 `
            --vm-sku "Standard_B1s" `
            --location ${{ env.LOCATION }}
        }

    - name: Get VMSS Public IP
      run: |
        $publicIp = az network public-ip show `
          --resource-group ${{ env.RESOURCE_GROUP }} `
          --name "${{ env.RESOURCE_GROUP }}-pip" `
          --query "ipAddress" -o tsv
        echo "PUBLIC_IP=$publicIp" >> $env:GITHUB_ENV

    - name: Test Connectivity
      run: |
        if ('${{ inputs.os_type }}' -eq 'linux') {
          # Test SSH
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 adminuser@${env:PUBLIC_IP} "echo 'SSH access successful'"
        } else {
          # Test RDP (basic connectivity check)
          Test-NetConnection -ComputerName ${env:PUBLIC_IP} -Port 3389
        }

    - name: Test Web Application
      run: |
        # Wait for VM to be ready
        Start-Sleep -Seconds 60
        # Test web app on port 80 or 8080
        try {
          $response = Invoke-WebRequest -Uri "http://${env:PUBLIC_IP}" -TimeoutSec 30
          if ($response.StatusCode -eq 200) {
            Write-Host "Web application is accessible"
          }
        } catch {
          Write-Host "Web application test failed"
        }