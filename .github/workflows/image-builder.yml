name: 'Image Builder and VMSS Provisioning'

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Name of the gallery image to use'
        required: true
        default: 'java-tomcat-image'
        type: string
      os_type:
        description: 'OS type: linux or windows'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - windows
      kv_name:
        description: 'Azure Key Vault name'
        required: true
        default: 'rgdevazurevmimagesmgmtkv'
        type: string    

env:
  RESOURCE_GROUP: 'rg-dev-azure-vm-images-mgmt'
  GALLERY_NAME: 'rgdevazurevmimagesmgmtga'
  LOCATION: 'westeurope'

jobs:
  provision-vmss:
    runs-on: ubuntu-latest  # Use Linux runner for Azure CLI

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get Public IP
      run: |
        PUBLIC_IP=$(curl -s https://api.ipify.org)
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
        echo "Allowed IP: $PUBLIC_IP"

    - name: Update Key Vault Network ACLs
      run: |
        KV_NAME="${{ inputs.kv_name }}"
        if [ -z "$KV_NAME" ]; then
          KV_NAME="rgdevazurevmimagesmgmtkv"
        fi
        if az keyvault show --name $KV_NAME --query name -o tsv >/dev/null 2>&1; then
          echo "Key Vault $KV_NAME exists. Adding IP $PUBLIC_IP to allowed IPs."
          az keyvault network-rule add --name $KV_NAME --ip-address "$PUBLIC_IP/32"
        else
          echo "Key Vault $KV_NAME does not exist. Skipping IP whitelisting."
        fi

    - name: Create Image Version
      run: |
        end_of_life=$(date -u -d '+1 month' +%Y-%m-%d)
        source_image_id="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Compute/images/${{ inputs.image_name }}-managed"
        az sig image-version create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --gallery-name ${{ env.GALLERY_NAME }} \
          --gallery-image-definition ${{ inputs.image_name }} \
          --gallery-image-version "latest" \
          --managed-image $source_image_id \
          --end-of-life-date $end_of_life \
          --target-regions "${{ env.LOCATION }}=1"
      shell: bash

    - name: Get Image ID
      run: |
        IMAGE_ID=$(az sig image-version show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --gallery-name ${{ env.GALLERY_NAME }} \
          --gallery-image-definition ${{ inputs.image_name }} \
          --gallery-image-version "latest" \
          --query "id" -o tsv)
        echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV

    - name: Provision VMSS
      run: |
        if [ "${{ inputs.os_type }}" = "linux" ]; then
          az vmss create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name "${{ env.RESOURCE_GROUP }}-vmss" \
            --image $IMAGE_ID \
            --admin-username "adminuser" \
            --generate-ssh-keys \
            --instance-count 1 \
            --vm-sku "Standard_B1s" \
            --location ${{ env.LOCATION }}
        else
          PASSWORD=$(az keyvault secret show \
            --vault-name "rgdevazurevmimagesmgmtkv" \
            --name "admin-password" \
            --query "value" -o tsv)
          az vmss create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name "${{ env.RESOURCE_GROUP }}-vmss" \
            --image $IMAGE_ID \
            --admin-username "adminuser" \
            --admin-password $PASSWORD \
            --instance-count 1 \
            --vm-sku "Standard_B1s" \
            --location ${{ env.LOCATION }}
        fi

    - name: Get VMSS Public IP
      run: |
        PUBLIC_IP=$(az network public-ip show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name "${{ env.RESOURCE_GROUP }}-pip" \
          --query "ipAddress" -o tsv)
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV

    - name: Test Connectivity
      run: |
        if [ "${{ inputs.os_type }}" = "linux" ]; then
          # Test SSH
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 adminuser@$PUBLIC_IP "echo 'SSH access successful'"
        else
          # Test RDP (basic connectivity check)
          nc -z $PUBLIC_IP 3389 && echo "RDP port open" || echo "RDP port closed"
        fi

    - name: Test Web Application
      run: |
        # Wait for VM to be ready
        sleep 60
        # Test web app on port 80 or 8080
        if curl -f --max-time 30 http://$PUBLIC_IP >/dev/null 2>&1; then
          echo "Web application is accessible"
        else
          echo "Web application test failed"
        fi