name: 'Image Builder and VMSS Provisioning'

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Name of the gallery image to use'
        required: true
        default: 'java-tomcat-image'
        type: string
      os_type:
        description: 'OS type: linux or windows'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - windows

env:
  RESOURCE_GROUP: 'rg-dev-azure-vm-images-mgmt'
  GALLERY_NAME: 'rgdevazurevmimagesmgmtga'
  LOCATION: 'westeurope'

jobs:
  provision-vmss:
    runs-on: windows-latest  # Use Windows runner for PowerShell

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup PowerShell
      run: |
        Install-Module -Name Az -AllowClobber -Force
        Import-Module Az

    - name: Get Image ID
      run: |
        $imageId = az sig image-version show `
          --resource-group ${{ env.RESOURCE_GROUP }} `
          --gallery-name ${{ env.GALLERY_NAME }} `
          --gallery-image-definition ${{ inputs.image_name }} `
          --gallery-image-version "latest" `
          --query "id" -o tsv
        echo "IMAGE_ID=$imageId" >> $env:GITHUB_ENV

    - name: Provision VMSS
      run: |
        if ('${{ inputs.os_type }}' -eq 'linux') {
          az vmss create `
            --resource-group ${{ env.RESOURCE_GROUP }} `
            --name "${{ env.RESOURCE_GROUP }}-vmss" `
            --image $env:IMAGE_ID `
            --admin-username "adminuser" `
            --generate-ssh-keys `
            --instance-count 1 `
            --vm-sku "Standard_B1s" `
            --location ${{ env.LOCATION }}
        } else {
          $password = az keyvault secret show `
            --vault-name "devazurevmimagesmgmtkv" `
            --name "admin-password" `
            --query "value" -o tsv
          az vmss create `
            --resource-group ${{ env.RESOURCE_GROUP }} `
            --name "${{ env.RESOURCE_GROUP }}-vmss" `
            --image $env:IMAGE_ID `
            --admin-username "adminuser" `
            --admin-password $password `
            --instance-count 1 `
            --vm-sku "Standard_B1s" `
            --location ${{ env.LOCATION }}
        }

    - name: Get VMSS Public IP
      run: |
        $publicIp = az network public-ip show `
          --resource-group ${{ env.RESOURCE_GROUP }} `
          --name "${{ env.RESOURCE_GROUP }}-pip" `
          --query "ipAddress" -o tsv
        echo "PUBLIC_IP=$publicIp" >> $env:GITHUB_ENV

    - name: Test Connectivity
      run: |
        if ('${{ inputs.os_type }}' -eq 'linux') {
          # Test SSH
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 adminuser@${env:PUBLIC_IP} "echo 'SSH access successful'"
        } else {
          # Test RDP (basic connectivity check)
          Test-NetConnection -ComputerName ${env:PUBLIC_IP} -Port 3389
        }

    - name: Test Web Application
      run: |
        # Wait for VM to be ready
        Start-Sleep -Seconds 60
        # Test web app on port 80 or 8080
        try {
          $response = Invoke-WebRequest -Uri "http://${env:PUBLIC_IP}" -TimeoutSec 30
          if ($response.StatusCode -eq 200) {
            Write-Host "Web application is accessible"
          }
        } catch {
          Write-Host "Web application test failed"
        }